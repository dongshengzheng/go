<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ctoangels.go.common.modules.go.mapper.RepairProgItemMapper">

    <!-- 通用查询结果列-->
    <sql id="Base_Column_List">
		id, repair_prog_detail_id AS repairProgDetailId, catagory, code, content, unit, `count`, remark,parent_code AS parentCode, info, sort, task_status AS taskStatus, repair_prog_id AS repairProgId, create_date AS createDate, create_by AS createBy, update_date AS updateDate, update_by AS updateBy, del_flag AS delFlag
	</sql>

    <select id="getItemsContainDetailName" resultType="RepairProgItem">
        SELECT item.*,(SELECT detail.pro_order_no FROM t_repair_prog_detail detail where detail.id=item.repair_prog_detail_id) AS proOrderNo FROM t_repair_prog_item item
        WHERE item.repair_prog_id=#{0} and item.catagory=#{1} and item.content="维修详单"
    </select>

    <select id="getCount" resultType="ItemCount">
        SELECT item.catagory catagory,count(*) as allCount,
        (case item.catagory when  "通用服务" then 1 when  "坞修工程" then 2
                                                    when  "船体工程" then 3 when  "机械工程" then 4
                                                    when  "电气工程" then 5 when  "冷藏工程" then 6
                                                    when  "特种设备" then 7 when  "其他" then 8 end ) as sort,
        SUM(case when item.task_status=0 then 1 else 0 end) as complete,
        SUM(case when item.task_status=1 then 1 else 0 end) as now,
        SUM(case when item.task_status=2 then 1 else 0 end) as notStart,
         SUM(case when item.task_status=3 then 1 else 0 end) as cancel,
        cast(SUM(case when item.task_status=0 then 1 else 0 end)/nullif(count(*),0)*100 as decimal(10,2)) as per
        from t_repair_prog_item item where item.repair_prog_id=#{0} AND item.content="维修详单" GROUP BY catagory ORDER BY sort
    </select>
</mapper>